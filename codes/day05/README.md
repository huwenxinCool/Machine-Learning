# 股票量化策略
- 量化交易策略基本有两种形式
	- 趋势交易（技术分析）
	- 市场中性（基本面分析）
		- 多因子选股
		- 趋势追踪
		- 注：不管是趋势追踪策略还是多因子选股策略，都是为了获取一定的超额收益。趋势追踪策略通过各种交易时机手段获取，而股票的多因子选股策略则是通过选股获得
- Alpha 和 Beta
	- 每个投资策略的收益率可以分解成两部分
		- 一部分与市场完全相关，整个市场的平均收益率乘以一个贝塔系数。贝塔可以称为这个投资组合的系统风险
		- 另一部分和整个市场无关叫做阿尔法（Alpha)
		- 总回报 = 市场回报 * Beta + Alpha
			- Alpha很难得， Beta很容易
			- Alpha就是精选个股，跑赢市场。
			- Beta就是有市场行情时跟上，有风险时候躲避
## 什么是多因子选股策略
- 多因子选股策略是一种应用十分广泛的选股策略，其基本思想就是找到某些影响股票收益的因子然后利用这些因子进行选股
- 多因子(Alpha因子)的种类
	- 基本面因子
		- 价值因子
		- 盈利因子
		- 成长因子
		- 资本结构因子
		- 运营因子
		- 流通性因子
	- 技术因子
		- 动量因子
		- 趋势因子
		- 市值因子
		- 波动因子
		- 成交量因子
	- 公司层面
		- 价值因子
		- 成长因子
		- 规模因子
		- 等
	- 市场层面
		- 趋势因子
		- 动量因子
		- 市值因子
	- 外部环境层面
		- 宏观环境
		- 行业环境
- FF三因子模型
	- 风险溢价因子
	- 规模因子
	- 价值因子。
- FF五因子模型
	- 风险溢价因子
	- 规模因子
	- 价值因子。
	- 盈利水平风险
	- 投资水平风险
## 多因子策略流程
- 因子挖掘
	- 因子数据处理
		- 去极值（去掉那些超大超小的数据）
		- 标准化
		- 中性化
	- 单因子的有效性检测
		- 因子IC分析
		- 因子收益率分析
		- 因子的方向
	- 多因子相关性和组合分析
		- 因子相关性
		- 因子合成
- 回测
	- 多因子选股的权重
	- 调仓周期
### 研究平台的使用
- https://www.ricequant.com/api/research/chn
- 获取合约历史数据
	- get_price(order_book_id, start_date='2013-01-04', end_date='2014-01-04', frequency='1d', fields=None, adjust_type='pre', skip_suspended =False, country='cn')
		- order_book_id	str OR str list	合约代码，可传入order_book_id, order_book_id list
		- start_date	str, datetime.date, datetime.datetime, pandasTimestamp开始日期，默认为'2013-01-04'。交易使用时，用户必须指定
		- end_date	str, datetime.date, datetime.datetime, pandasTimestamp结束日期，默认为'2014-01-04'。交易使用时，默认为策略当前日期前一天
		- frequency	str	历史数据的频率。 现在支持日/分钟级别的历史数据，默认为'1d'。使用者可自由选取不同频率，例如'5m'代表5分钟线
		- fields	str OR str list	返回字段名称
		- adjust_type	str	前复权处理。前复权 - pre，后复权 - post，不复权 - none，回测使用 - internal需要注意，internal数据与回测所使用数据保持一致，仅就拆分事件对价格以及成交量进行了前复权处理，并未考虑分红派息对于股价的影响。所以在分红前后，价格会出现跳跃。
		- skip_suspended	bool	是否跳过停牌数据。默认为False，不跳过，用停牌前数据进行补齐。True则为跳过停牌期。注意，当设置为True时，函数order_book_id只支持单个合约传入
		- country	str	默认是中国市场('cn')，目前仅支持中国市场

		-传入一个order_book_id，多个fields，函数会返回pandas DataFrame
		- 传入一个order_book_id，一个field，函数会返回pandas Series
		- 传入多个order_book_id，一个field，函数会返回pandas DataFrame
		- 传入多个order_book_id，函数会返回pandas
- 获取交易日列表
	- get_trading_dates(start_date, end_date, country='cn')
	- start_date	str, datetime.date, datetime.datetime, pandasTimestamp	开始日期
	- end_date	str, datetime.date, datetime.datetime, pandasTimestamp	结束日期
	- country	str	默认是中国市场('cn')，目前仅支持中国市场
- 查询财务数据
	- get_fundamentals(query, entry_date, interval=None, report_quarter=False)

		- query	SQLAlchemyQueryObject	SQLAlchmey的Query对象。其中可在'query'内填写需要查询的指标，'filter'内填写数据过滤条件。具体可参考 sqlalchemy's query documentation 学习使用更多的方便的查询语句。从数据科学家的观点来看，sqlalchemy的使用比sql更加简单和强大
		- entry_date	str, datetime.date, datetime.datetime, pandasTimestamp	查询财务数据的基准开始日期
		- interval	str	查询财务数据的间隔。例如，填写'5y'，则代表从entry_date开始（包括entry_date）回溯5年，返回数据时间以年为间隔。'd' - 天，'m' - 月（30天）， 'q' - 季（90天），'y' - 年（365天）
		- report_quarter	bool	是否显示报告期，默认为False，不显示。'Q1' - 一季报，'Q2' - 半年报，'Q3' - 三季报，'Q4' - 年报
## 因子处理（去极值）
	- 什么是因子去极值处理
		- 去极值并不是删除”异常数据”,而是将这些数据”拉回”到正常的值

	- 三种方法
		- 分位数去极值
			- 1、中位数
				- 在有序的情况下，去中间的那个数， 如果是个数是偶数就去中间2个数的平均数
				- 1, 2, 3, 4, 5
                    - 中位数:3
                - 1, 2, 3, 4, 5, 6
                    - 中位数:3.5
			- 2、四分位数 (n+1)/4 * 分位值
				- 情况一:
                - 14、15、16、16、17、18、18、19、19、20、21、21、22、22、23、24、24、25、26
                    - Q1 --> 17
                    - Q2 --> 20
                    - Q3 --> 23
                - 情况二:
                - 14、15、16、16、17、18、18、19、19、20、21、21、22、22、23、24、24、25、26、27
                    - Q1 --> 5.25 --> 17 + (18-17)*0.25 --> 17.25
                    - Q2 --> 10.5 --> 20 + (21-20)*0.5 --> 20.5
                    - Q3 --> 15.75 --> 23 + (24-23)*0.75 --> 23.75
			- 3、百分位数
				- quantile -- 小数 --[0,1]
                - percenttile -- 整数 -- [0, 100]
		- 中位数绝对偏差去极值
		- 正态分布去极值

## 分位数去极值
- 1.原理
	- 将指定分位数区间以外的极值用分位点的值替换掉
- 2.实现方式
	- 1.winsorize调用
		- scipy.stats.mstats.winsorize(a, limits=None)
		- a : sequence Input array.
		- limits : float 数据两端的percentile的值
	- 2.自实现
		- 根据np.percentile获取百分位的上限值和下限值,然后后进行替换的思想.
## 中位数绝对偏差去极值[***]
- 1.步骤:
	- 1 找出因子的中位数 median
	- 2 得到每个因子值与中位数的绝对偏差值 |x – median|
	- 3 得到绝对偏差值的中位数， MAD，median(|x – median|)
	- 4 计算MAD_e = 1.4826*MAD，然后确定参数 n，做出调整
- 2.举例:
	- 计算过程:
	- 10, 3, 5, 7, 20 --> 5
	- 15, 2, 0, 2, 15 --> 0, 2, 2, 15, 15 --> 2(MAD)
	- MAD_e = 1.4826*2 = 2.9652
	- up_scale = 5 + 3*2.9652 = 13.8956
	- down_scale = 5 - 3*2.9652 = -3.8956
 	- [-3.8956, 13.8956]

	- 修改原来数据的范围
	- -3.8956, 3, 5, 7, 13.8956

## 4. 正态分布去极值
	- 1.原理
	-    根据99.73%的数据再三个标准差范围之内,进行筛选
	- 2.流程
	-    1.计算均值,标准差
	-    2.求解替换上下限
	-       up = mean + 3*sigma
	-       down = mean - 3*sigma
	-    3.进行替换
## 5.小结
	- 在做去极值处理的时候最好不要使用正态分布去极值法，推荐使用分位数和中位数绝对偏差

## 3.6 因子数据处理 - 标准化
	- 1.标准化处理内容
	-    把数据变到均值为了0, 标准差为1
	-    注意: 去极值和标准化是两种完全不同的数据处理方式,完全可以同时进行
	- 2. 实现
	-    1. 借助standardscaler实现
	-    2. 自实现
	-       借助公式 (x - mean)/std
	-       流程:
	-          1.求解均值,标准差
	-          2.使用公式,求解标准化之后的值
## 3.7 因子数据处理-市值中性化
	- 1.市值中性化目的
	-    为了在因子选股回测的时候，防止选到的股票集中在固定的某些股票当中
	- 2 怎么去除市值影响
	-    通过建立线性回归关系,构建模型
	-    自变量 -- 市值因子
	-    因变量 -- 被去除	- 
	-    偏差即为保留下来的某因子除去市值影响的部分
	- 3.流程
	-    获取两个因子数据
	-    对目标值因子-市净率进行去极值、标准化处理
	-    建立市值与市净率回归方程
	-    通过回归系数，预测新的因子结果y_predict
	-    求出市净率与y_predict的偏差即为新的因子值
	- 4.案例流程分析
	-    流程分析
	-        init：
	-            选定股票范围：沪深300
	-            确定更新股票池的周期：按月
	-        select_stocks：
	-            获取因子值：市值market_cap 市净率pb_ratio
	-            处理缺失值
	-            因子处理：去极值，标准化，市值中性化
	-            选股：前20%
	-        treat_data：
	-            去极值和标准化
	-            市值中性化处理
	-            线性回归预估器流程
	-        before_trading
	-            pass
	-        handle_bar：
	-            每日调仓
	-        after_trading:
	-     